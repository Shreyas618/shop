<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Retailer & Wholesale Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --pri:#0d6efd; --bg:#f5f7fb; --card:#ffffff; --line:#e5e7eb; --text:#1f2937;
  }
  *{box-sizing:border-box}
  body{
    margin:24px; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--text);
  }
  h2{margin:18px 0 10px}
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 6px 20px rgba(0,0,0,.06); padding:14px;
  }
  table{width:100%; border-collapse:collapse}
  thead th{
    background:var(--pri); color:#fff; font-weight:600; padding:10px; text-align:center;
  }
  tbody td, tfoot td{border-top:1px solid var(--line); padding:6px; text-align:center}
  tbody tr:hover{background:#fafafa}
  input, select{
    width:100%; padding:6px 8px; border:1px solid var(--line); border-radius:8px;
    background:#fff; text-align:center; outline:none;
  }
  input[readonly]{background:#f9fafb}
  tfoot td{font-weight:700; background:#f3f4f6}
  .totals{
    display:grid; gap:12px; margin-top:16px;
  }
  .final{
    background:#22c55e; color:#fff; border-radius:12px; padding:14px; text-align:center; font-weight:800;
  }
  .grid{display:grid; gap:18px}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .note{font-size:12px; color:#6b7280; margin-top:6px}
  .btns{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;}
  button{padding:6px 12px; border:none; border-radius:8px; background:var(--pri); color:white; cursor:pointer;}
  button:hover{opacity:0.85;}
</style>
</head>
<body>

<div class="grid">
  <!-- Retailer -->
  <section class="card">
    <h2>Retailer</h2>
    <div class="note">Sell = Opening − Closing − WholesaleQty(for this brand)</div>
    <div class="btns">
      <button id="copyClosingBtn">Copy Closing Stock</button>
      <button id="pasteOpeningBtn">Paste to Opening Stock</button>
      <button id="clearOpeningBtn">Clear Opening Stock</button>
    </div>
    <table id="retailerTable">
      <thead>
        <tr>
          <th>ml</th>
          <th>Brand Name</th>
          <th>Opening Stock</th>
          <th>Closing Stock</th>
          <th>Sell</th>
          <th>MRP</th>
          <th>Wholesale Qty</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="retailerBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="7">Retailer Total</td>
          <td id="retailerTotal">0.00</td>
        </tr>
      </tfoot>
    </table>
  </section>

  <!-- Wholesale -->
  <section class="card">
    <h2>Wholesale</h2>
    <div class="note">Brand list comes from Retailer brands (type there first).</div>
    <table id="wholesaleTable">
      <thead>
        <tr>
          <th>Brand Name</th>
          <th>Quantity</th>
          <th>MRP</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="wholesaleBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="3">Wholesale Total</td>
          <td id="wholesaleTotal">0.00</td>
        </tr>
      </tfoot>
    </table>
  </section>
</div>

<!-- Final -->
<section class="totals">
  <div class="final" id="finalTotal">Final = 0.00</div>
</section>

<script>
  const retailerBody   = document.getElementById('retailerBody');
  const wholesaleBody  = document.getElementById('wholesaleBody');
  const retailerTotalC = document.getElementById('retailerTotal');
  const wholesaleTotalC= document.getElementById('wholesaleTotal');
  const finalTotalC    = document.getElementById('finalTotal');

  const ROWS_RETAILER  = 12; // updated to match provided data length
  const ROWS_WHOLESALE = 5;

  const mlData   = ["180ml","180ml","90ml","180ml","90ml","180ml","90ml","90ml","650ml","500ml","330ml","650ml"];
  const brandData= ["Spl(G)","Spl(P)","Spl","TP(P)","TP","karan","karan","Rg Dr","TB","TB","TB","CB"];
  const mrpData  = [80,80,45,80,45,70,35,55,240,170,150,260];

  const nf = (n)=> (isNaN(n) ? '0.00' : Number(n).toFixed(2));
  const num = (el)=> {
    const v = parseFloat(typeof el === 'string' ? el : el.value);
    return isNaN(v) ? 0 : v;
  };
  const norm = (s)=> (s || '').trim().toLowerCase();

  function saveData(){
    const data = {
      retailer: Array.from(retailerBody.querySelectorAll('tr')).map(row => ({
        open: row.querySelector('.open').value,
        close: row.querySelector('.close').value
      }))
    };
    localStorage.setItem('stockData', JSON.stringify(data));
  }

  function loadData(){
    const data = JSON.parse(localStorage.getItem('stockData') || '{}');
    if(data.retailer){
      data.retailer.forEach((rowData, i) => {
        const row = retailerBody.querySelectorAll('tr')[i];
        if(row){
          row.querySelector('.open').value = rowData.open ?? 0;
          row.querySelector('.close').value = rowData.close ?? 0;
        }
      });
    }
  }

  function createRetailerRows(){
    for(let i=0;i<ROWS_RETAILER;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text"   class="ml"       value="${mlData[i] || ''}" placeholder="ml"></td>
        <td><input type="text"   class="brand"    value="${brandData[i] || ''}" placeholder="Brand"></td>
        <td><input type="number" class="open"     value="0"></td>
        <td><input type="number" class="close"    value="0"></td>
        <td><input type="number" class="sell"     value="0" readonly></td>
        <td><input type="number" class="mrp"      value="${mrpData[i] || 0}"></td>
        <td><input type="number" class="whqty"    value="0" readonly></td>
        <td class="rTotal">0.00</td>
      `;
      retailerBody.appendChild(tr);
    }
  }

  function createWholesaleRows(){
    for(let i=0;i<ROWS_WHOLESALE;i++){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <select class="wBrand">
            <option value="">Select brand</option>
          </select>
        </td>
        <td><input type="number" class="wQty" value="0"></td>
        <td><input type="number" class="wMrp" value="0"></td>
        <td class="wsTotal">0.00</td>
      `;
      wholesaleBody.appendChild(tr);
    }
  }

  function getRetailerBrands(){
    const set = new Set();
    retailerBody.querySelectorAll('.brand').forEach(inp=>{
      const b = inp.value.trim();
      if(b) set.add(b);
    });
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }

  function refreshWholesaleDropdowns(){
    const brands = getRetailerBrands();
    wholesaleBody.querySelectorAll('.wBrand').forEach(sel=>{
      const current = sel.value;
      sel.innerHTML = `<option value="">Select brand</option>` +
        brands.map(b=>`<option value="${b}">${b}</option>`).join('');
      if (brands.includes(current)) sel.value = current;
    });
  }

  function recalc(){
    const brandQty = {};
    let wholesaleTotal = 0;

    wholesaleBody.querySelectorAll('tr').forEach(row=>{
      const brand = row.querySelector('.wBrand').value;
      const qty   = num(row.querySelector('.wQty'));
      const mrp   = num(row.querySelector('.wMrp'));
      const rowTotal = qty * mrp;
      row.querySelector('.wsTotal').textContent = nf(rowTotal);
      wholesaleTotal += rowTotal;

      if(brand){
        const key = norm(brand);
        brandQty[key] = (brandQty[key] || 0) + qty;
      }
    });
    wholesaleTotalC.textContent = nf(wholesaleTotal);

    let retailerTotal = 0;
    retailerBody.querySelectorAll('tr').forEach(row=>{
      const brandKey = norm(row.querySelector('.brand').value);
      const open     = num(row.querySelector('.open'));
      const close    = num(row.querySelector('.close'));
      const mrp      = num(row.querySelector('.mrp'));
      const whQty    = brandKey ? (brandQty[brandKey] || 0) : 0;

      row.querySelector('.whqty').value = whQty;
      const sell = open - close - whQty;
      row.querySelector('.sell').value = sell;

      const rowTotal = sell * mrp;
      row.querySelector('.rTotal').textContent = nf(rowTotal);
      retailerTotal += rowTotal;
    });
    retailerTotalC.textContent = nf(retailerTotal);
    finalTotalC.textContent = `Final = ${nf(retailerTotal + wholesaleTotal)}`;
    saveData();
  }

  function wireEvents(){
    retailerBody.addEventListener('input', e=>{
      if (e.target.classList.contains('brand')) refreshWholesaleDropdowns();
      recalc();
    });
    wholesaleBody.addEventListener('input', recalc);
    wholesaleBody.addEventListener('change', recalc);

    document.getElementById('copyClosingBtn').addEventListener('click', ()=>{
      const closings = Array.from(retailerBody.querySelectorAll('.close')).map(inp => inp.value);
      localStorage.setItem('closingCopy', JSON.stringify(closings));
      navigator.clipboard.writeText(JSON.stringify(closings));
      alert('Closing stock copied!');
    });

    document.getElementById('pasteOpeningBtn').addEventListener('click', ()=>{
      const closings = JSON.parse(localStorage.getItem('closingCopy') || '[]');
      retailerBody.querySelectorAll('.open').forEach((inp, i)=>{
        if(closings[i] !== undefined) inp.value = closings[i];
      });
      recalc();
    });

    document.getElementById('clearOpeningBtn').addEventListener('click', ()=>{
      retailerBody.querySelectorAll('.open').forEach(inp => inp.value = 0);
      recalc();
    });

    // ✅ Enter key moves to next row in same column
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const inputs = Array.from(document.querySelectorAll('input, select'));
        const currentIndex = inputs.indexOf(document.activeElement);
        if(currentIndex !== -1){
          e.preventDefault();
          const cellIndex = document.activeElement.closest('td')?.cellIndex;
          if(cellIndex !== undefined){
            const rows = Array.from(document.activeElement.closest('tbody').rows);
            for(let r=0; r<rows.length; r++){
              const cellInput = rows[r].cells[cellIndex]?.querySelector('input, select');
              if(cellInput === document.activeElement && rows[r+1]){
                const nextInput = rows[r+1].cells[cellIndex]?.querySelector('input, select');
                if(nextInput) nextInput.focus();
                break;
              }
            }
          }
        }
      }
    });
  }

  createRetailerRows();
  createWholesaleRows();
  refreshWholesaleDropdowns();
  loadData();
  wireEvents();
  recalc();
</script>

</body>
</html>
